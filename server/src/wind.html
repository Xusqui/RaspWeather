<html>
<head>
<title>IP Anemometer</title>
<link rel="stylesheet" type="text/css" href="ipa.css" />

<script type="text/javascript" src="ipa.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
google.load('visualization', '1.0', {'packages':['corechart']});
google.setOnLoadCallback(onLoadHandler);

function onLoadHandler() {
  var stats = ipa.requestStats(document.getElementById('ipaMinutes').value);  // XXX
  if (stats == null) {
    // TODO: Handle this properly.
    document.getElementById('ipaWind').innerHTML = "n/a";
    return;
  }

  var speedDataTable = new google.visualization.DataTable();
  speedDataTable.addColumn('datetime', 't');
  speedDataTable.addColumn('number', 'avg');
  speedDataTable.addColumn('number', 'max');
  var timeSeries = stats[ipa.WIND_KEY_TIME_SERIES];
  for (var i = 0; i < timeSeries.length; ++i) {
    var row = timeSeries[i];
    row[0] = new Date(row[0]);
    speedDataTable.addRow(row);
  }
  var options = {
    title: 'Wind [km/h]',
    hAxis: {format: 'HH:mm:ss'},
    legend: {position: 'bottom'}
  };
  var speedChart = new google.visualization.LineChart(document.getElementById('time_div'));
  speedChart.draw(speedDataTable, options);

  var histogramDataTable = new google.visualization.DataTable();
  var histogram = stats[ipa.WIND_KEY_HIST];
  histogramDataTable.addColumn('number', 'km/h');
  histogramDataTable.addColumn('number', '%');
  histogramDataTable.addColumn('number', '%>=');
  var totalPercent = 100;
  for (var kmh in histogram) {
    var percent = histogram[kmh] * 100;
    histogramDataTable.addRow([parseInt(kmh), percent, totalPercent]);
    totalPercent -= percent;
  }
  options = {
    title: 'Wind [km/h]',
    hAxis: {gridlines: {count: -1}},
    series: {
      0: {targetAxisIndex: 0, type: 'bars'},
      1: {targetAxisIndex: 1, type: 'lines'}
    },
    vAxes: {
      0: {minValue: 0},
      1: {minValue: 0, maxValue: 100}
    }
  };
  if (Object.keys(histogram).length == 1) {
    options.vAxes[0].maxValue = 100;
  }
  var histogramChart = new google.visualization.ComboChart(document.getElementById('hist_div'));
  histogramChart.draw(histogramDataTable, options);
}
</script>

</head>
<body>
<div id="ipaWind">loading...</div>
Minutes:
<input id="ipaMinutes" type="text" maxlength="4" size="4" onkeyup="onLoadHandler()" value="3" />
<hr />

<div style="width: 100%; overflow: hidden;">
<div id="time_div" style="width: 400px; height: 300px; float: left"></div>
<div id="hist_div" style="margin-left: 400px; width: 400px; height: 300px"></div>
</div>

</body>
</html>
